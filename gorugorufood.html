

<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>음식 보드</title>
    <script src="https://cdn.socket.io/4.0.0/socket.io.min.js"></script>
    
    <style>
        @font-face {
            font-family: 'Happiness-Sans-Title';
            src: url('https://fastly.jsdelivr.net/gh/projectnoonnu/noonfonts_2205@1.0/Happiness-Sans-Title.woff2') format('woff2');
            font-weight: normal;
            font-style: normal;
            font-display: swap;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            margin: 0;
            padding: 0;
            font-family: 'Happiness-Sans-Title', sans-serif;
            background-color: #FFE693;
            height: 100vh;
            display: flex;
            flex-direction: column;
            text-align: center;
            justify-content: space-between;
            overflow: hidden;
        }

        .container{
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .menu-btn {
            position: absolute;
            top: 45px;
            left: 60px;
            width: 94.5px;
            height: 84px;
            background-color: white;
            border-radius: 10px;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .content {
            text-align: center;
        }

        .content p {
            color: #000000;
            font-size: 70px;
            font-family: "Happiness-Sans-Title";
            line-height: 143%;
            letter-spacing: -3.36px;
            transition: font-size 1s, opacity 1s;
        }

        .foodboard {
            position: relative;
            margin-top: 0px;
            width: 100%;
            max-width: 1050px;
            height: auto;
            display: flex;
            justify-content: center;
        }

        .background-blur {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 1200px;
            height: 1200px;
            background-color: #ffdb26dd;
            border-radius: 50%;
            filter: blur(100px);
            transform: translate(-50%, -50%);
            z-index: -1;
        }

        .submit-btn {
            border-radius: 68.2px;
            border: 1.218px solid #FFF;
            background: linear-gradient(180deg, #FFF 0%, rgba(255, 255, 255, 0.00) 100%);
            box-shadow: 4.871px 4.871px 48.714px 0px rgba(255, 184, 0, 0.50);
            color: #B98500;
            text-align: center;
            font-family: 'Happiness-Sans-Title';
            font-size: 32px;
            opacity: 0.4;
            width: 320px;
            height:90px;
            letter-spacing: -1px;
            pointer-events: none; /* 기본적으로 버튼은 클릭 불가능 */
        }

        .food1 img {
            position: absolute;
            top: 128px;
            left: 507px;
            width: 226px;
            height: 226px;
            border-radius: 34px;
            
        }

        .food2 img {
            position: absolute;
            top: 393px;
            left: 381px;
            width: 226px;
            height: 226px;
            border-radius: 34px;
          
        }

        .food1 img, .food2 img {
    visibility: visible !important;
    display: block !important;
}



        @media (max-height: 1920px) {
            .content p { font-size: 56px; }
            .foodboard img { max-width: 1400px; }
            .food1 img { max-width: 226px; } 
            .food2 img { max-width: 226px; } 
        }


        #serialButton {
            position: absolute;
            bottom: 50px;
            left: 50%;
            transform: translateX(-50%);
            width: 100%;
            height: 100px;
            border: none;
            cursor: pointer;
            z-index: 2;
            opacity: 0;
        }

        .overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.5); /* 검은색으로 dim 처리 */
    display: none; /* 기본적으로 숨김 */
    justify-content: center;
    align-items: center;
    flex-direction: column; /* 수직으로 정렬 */
    z-index: 10; /* 다른 요소 위에 표시 */
}

.loading-gif {
    max-width: 300px; /* GIF 크기 조정 */
    display: none; /* 기본적으로 숨김 */
}

.loading-text {
        color: #FFF; /* 텍스트 색상 */
        font-size: 50px; /* 텍스트 크기 */
        margin-top: -20px; /* GIF와 텍스트 간격 */
        text-align: center; /* 중앙 정렬 */
    }
    </style>
</head>

<body>
<div class="container">
    <div class="menu-btn">
        <img src="menu2.svg" alt="menu" />
    </div>

    <div class="background-blur"></div>

    <div class="content">
        <p class="title">먹고 싶은 음식을 올려 놓아보세요!</p>
    </div>

    <div class="foodboard" id="foodboard">
        <img src="foodboard.png" alt="식판보드" />

        <div id="food1" class="food1">
            <img src="blank.png"/>
        </div>

        <div id="food2" class="food2">
            <img src="blank.png"/>
        </div>
    </div>    

    <button class="submit-btn" id="submitButton">다 올려놨어요!</button>
    <button id="serialButton">연결하기</button>

    <div class="overlay" id="overlay">
        <img src="loadingloop.gif" alt="Loading" class="loading-gif" id="loadingGif" />
        <p class="loading-text">음식을 분석 중이에요...</p> <!-- 텍스트 추가 -->
    </div>
    
</div>

<script>
let port;
let reader;
let currentTag = null; // 현재 태그를 저장할 변수
let lastTag = null; // 마지막에 읽힌 태그를 저장하는 변수
const connectButton = document.getElementById('serialButton');
const food1 = document.getElementById("food1");
const food1Image = food1.querySelector("img");
const food2 = document.getElementById("food2");
const food2Image = food2.querySelector("img");
const submitButton = document.getElementById("submitButton");

    window.onload = () => {
        connectButton.style.display = "block"; // 연결 버튼 보이기
    };

    connectButton.addEventListener('click', async () => {
        await connectToSerial();
    });

    async function connectToSerial() {
    try {
        port = await navigator.serial.requestPort(); // 포트 선택
        await port.open({ baudRate: 9600 }); // 시리얼 통신 설정
        const reader = port.readable.getReader(); // 리더 초기화
        readFromSerial(reader); // 리더에서 데이터 읽기
        connectButton.innerText = "연결됨";
        connectButton.disabled = true; // 버튼 비활성화
    } catch (error) {
        console.error("시리얼 연결 에러:", error);
        connectButton.innerText = "연결 실패, 다시 시도";
    }
}


    async function readFromSerial(reader) {
    while (port.readable) {
        try {
            const { value, done } = await reader.read();
            if (done) {
                console.log("리더 종료");
                break;
            }
            const tagData = new TextDecoder().decode(value).trim(); // 시리얼에서 수신한 데이터
            console.log("", tagData); // 수신된 데이터 로그 추가

            // data.split(":")로 나누기
            const parts = tagData.split(":");
            const tagUID = parts.length > 1 ? parts[1] : parts[0]; // UID 추출
            console.log("추출된 UID:", tagUID); // UID 출력 추가

            if (tagData.startsWith("food1:")) {
                updateFood1Image(tagUID); // food1 업데이트
                } else if (tagData.startsWith("food2:")) {
                    updateFood2Image(tagUID); // food2 업데이트
                    }

        } catch (error) {
            console.error("데이터 읽기 에러:", error); // 에러 핸들링
            alert("데이터 읽기 중 오류가 발생했습니다."); // 사용자에게 알림
            break;
        }
    }
}
function updateFood1Image(tagUID) {
    console.log("food1 태그 UID:", tagUID); // 태그 UID 확인
    console.log("food1 이미지:", food1Image.src);
    if (tagUID === '02DBB71B') {
        food1Image.src = 'riceblock.png';
        console.log("이미지 업데이트: riceblock.png");
        food1Image.style.visibility = 'visible';
    } else if (tagUID === '71FFF727') {
        food1Image.src = 'appleblock.png';
        console.log("이미지 업데이트: appleblock.png");
        food1Image.style.visibility = 'visible';
    } else if (tagUID === '1298811B') {
        food1Image.src = 'friedpotatoblock.png';
        console.log("이미지 업데이트: friedpotatoblock.png");
        food1Image.style.visibility = 'visible';
    } else if (tagUID === '0287AC1B') {
        food1Image.src = 'milkblock.png';
        console.log("이미지 업데이트: milkblock.png");
        food1Image.style.visibility = 'visible';
    } else {
        console.log("알 수 없는 UID: ", tagUID); // 추가 확인
    }
    food1Image.style.visibility = 'visible';
    checkBothImages(); // 이미지가 바뀔 때마다 체크
}


function updateFood2Image(tagUID) {
    console.log("food1 태그 UID:", tagUID); // 태그 UID 확인
    console.log("food2 이미지:", food2Image.src);
    if (tagUID === '02DBB71B') {
        food2Image.src = 'riceblock.png';
        console.log("이미지 업데이트: riceblock.png");
        food2Image.style.visibility = 'visible';
    } else if (tagUID === '71FFF727') {
        food2Image.src = 'appleblock.png';
        console.log("이미지 업데이트: appleblock.png");
        food2Image.style.visibility = 'visible';
    } else if (tagUID === '1298811B') {
        food2Image.src = 'friedpotatoblock.png';
        console.log("이미지 업데이트: friedpotatoblock.png");
        food2Image.style.visibility = 'visible';
    } else if (tagUID === '0287AC1B') {
        food2Image.src = 'milkblock.png';
        console.log("이미지 업데이트: milkblock.png");
        food2Image.style.visibility = 'visible';
    } else {
        console.log("알 수 없는 UID: ", tagUID); // 추가 확인
        food2Image.style.visibility = 'visible';
    checkBothImages(); // 이미지가 바뀔 때마다 체크
    }
}

function checkBothImages() {
    // food1Image와 food2Image의 src가 빈 문자열이 아니고, 이미지가 설정되어 있을 때만 버튼 활성화
    if (food1Image.src && food1Image.src !== window.location.href && food2Image.src && food2Image.src !== window.location.href) {
        submitButton.style.opacity = 1;
        submitButton.style.pointerEvents = 'auto'; // 버튼 활성화
    }
}
submitButton.addEventListener('click', () => {
    // 전체 화면 dim 처리
    const overlay = document.getElementById('overlay');
    const loadingGif = document.getElementById('loadingGif');

    overlay.style.display = 'flex'; // dim 오버레이 보이기
    loadingGif.style.display = 'block'; // GIF 보이기

        // 3초 후에 resultfoodboard.html로 전환
        setTimeout(() => {
        window.location.href = 'resultfoodboard.html';
    }, 3000);
});
</script>

</body>
</html>


